<!doctype html>
<html>
  <head>
    <title>My experiment</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-button-response.js"></script>

    <script src="platform.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
  </body>
  <script>

	// generate a random subject ID
	var subject_id = Math.floor(Math.random()*100000);

	// pick a random condition for the subject at the start of the experiment
	var condition_assignment = jsPsych.randomization.sample(['conditionA', 'conditionB', 'conditionC'],1)[0];

	// get info on the browser (we probably don't need this any more with the platform script)
	navigator.sayswho= (function(){
		var ua= navigator.userAgent, tem,
		M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
		if(/trident/i.test(M[1])){
			tem=  /\brv[ :]+(\d+)/g.exec(ua) || [];
			return 'IE '+(tem[1] || '');
		}
		if(M[1]=== 'Chrome'){
			tem= ua.match(/\b(OPR|Edge)\/(\d+)/);
			if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
		}
		M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
		if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
		return M.join(' ');
	})();
	
	// This script sets OSName variable as follows: (we probably don't need this any more with the platform script)
	// "Windows"    for all versions of Windows
	// "MacOS"      for all versions of Macintosh OS
	// "Linux"      for all versions of Linux
	// "UNIX"       for all other UNIX flavors 
	// "Unknown OS" indicates failure to detect the OS
	var OSName="Unknown OS";
	if (navigator.appVersion.indexOf("Win")!=-1) OSName="Windows";
	if (navigator.appVersion.indexOf("Mac")!=-1) OSName="MacOS";
	if (navigator.appVersion.indexOf("X11")!=-1) OSName="UNIX";
	if (navigator.appVersion.indexOf("Linux")!=-1) OSName="Linux";

	// record the condition assignment in the jsPsych data
	// this adds a property called 'subject' and a property called 'condition' to every trial
	jsPsych.data.addProperties({
	  random_subject: subject_id,
	  condition: condition_assignment,
	  browser: navigator.sayswho,
	  OSName : OSName,
	  platform: platform.description,
	  subject : jsPsych.data.getURLVariable('subject')
	});
	// add the properties that were passed through the URL
//	jsPsych.data.addProperties(platform.description);	

	// defining groups of questions that will go together.
	var page_1_questions = ["I like vegetables.", "I hate eggs."];

	// defining two different response scales that can be used.
	var scale_1 = ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"];

	var likert_page = {
		type: 'survey-likert',
		questions: ["I like vegetables.", "I like fruit."],
		labels: [scale_1, scale_1], // need one scale for every question on a page
		data: "liking likert"
	};
	
  /* define welcome message block */
  var welcome_block = {
    type: "text",
    text: "Welcome to the experiment. Click to begin.",
    cont_key: 'mouse'
  };

  /* define instructions block */
  var instructions_block = {
    type: "text",
    text: "<p>In this experiment, a circle will appear in the center " +
        "of the screen.</p><p>If the circle is <strong>blue</strong>, " +
        "click the button onder the circle labeled 'blue'.</p>" +
        "<p>If the circle is <strong>orange</strong>, do not click.</p>" +
        "<div class='left center-content'><img src='img/blue.png'></img>" +
        "<p class='small'><strong>Press the F key</strong></p></div>" +
        "<div class='right center-content'><img src='img/orange.png'></img>" +
        "<p class='small'><strong>Do not press a key</strong></p></div>" +
        "<p>Click to begin.</p>",	
    timing_post_trial: 2000,
    cont_key: 'mouse'
  };

  /* define test block */

  var test_stimuli = [
    {
      stimulus: "img/blue.png",
      data: { response: 'go' }
    },
    {
      stimulus: "img/orange.png",
      data: { response: 'no-go' }
    }
  ];

  var all_trials = jsPsych.randomization.repeat(test_stimuli, 2);

  var post_trial_gap = function() {
    return Math.floor( Math.random() * 1500 ) + 750;
  }

  var test_block = {
    type: "button-response",
    choices: ['This circle is blue'],
    button_html: "<a class='jspsych-btn'>%choice%</a>",
    timing_response: 1500,
    timing_post_trial: post_trial_gap,
    on_finish: function(data){
      var correct = false;
      if(data.response == 'go' && data.rt > -1){
        correct = true;
      } else if(data.response == 'no-go' && data.rt == -1){
        correct = true;
      }
      jsPsych.data.addDataToLastTrial({correct: correct});
    },
    timeline: all_trials
  };

  /* define debrief block */

  function getSubjectData() {

    var trials = jsPsych.data.getTrialsOfType('button-response');

    var sum_rt = 0;
    var correct_trial_count = 0;
    var correct_rt_count = 0;
    for (var i = 0; i < trials.length; i++) {
      if (trials[i].correct == true) {
        correct_trial_count++;
        if(trials[i].rt > -1){
          sum_rt += trials[i].rt;
          correct_rt_count++;
        }
      }
    }
    return {
      rt: Math.floor(sum_rt / correct_rt_count),
      accuracy: Math.floor(correct_trial_count / trials.length * 100)
    }
  }

  var debrief_block = {
    type: "text",
    text: function() {
      var subject_data = getSubjectData();
      
	  var survey_trials = jsPsych.data.getTrialsOfType('survey-likert');
	  /*var survey_responses_str = "";
	  for (var i = 0; i < survey_trials.length; i++) {
	        survey_responses_str += i + ": " + survey_trials[i].response + " "
	        }*/
      return "<p>You responded correctly on "+subject_data.accuracy+"% of "+
      "the trials.</p><p>Your average response time was <strong>" +
      subject_data.rt + "ms</strong>.</p><p>Likert responses:<br>"+survey_trials.responses+ "</p><p>Press any key to complete the experiment. Thank you!</p>";
    }
  };

  /* create experiment timeline array */
  var timeline = [];
//  timeline.push(welcome_block);
  timeline.push(likert_page);
  timeline.push(instructions_block);
  timeline.push(test_block);
  timeline.push(debrief_block);

  /* start the experiment */
  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
</script>
</html>